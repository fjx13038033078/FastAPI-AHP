# AHP风险评估系统

基于AHP（层次分析法）的风险评估系统，支持45个风险指标的综合评估和PDF报告生成。

## 🎯 系统特性

- ✅ **完整的45指标体系**：覆盖人员、物品、环境、管理、任务五大因素
- ✅ **多选指标支持**：支持弹药类型、道路类型、车辆安全等多选指标
- ✅ **智能风险评估**：基于5种计算情况的完整风险评估算法
- ✅ **敏感度系数调节**：根据敏感时期、地域、属性动态调整风险系数
- ✅ **灵活输入格式**：支持拼音编码和indicator格式，支持字符串类型输入
- ✅ **PDF报告生成**：自动生成标准格式的风险评估报告
- ✅ **中文字体支持**：完美显示中文内容
- ✅ **RESTful API**：标准化的HTTP接口
- ✅ **模块化架构**：易于维护和扩展

## 🚀 核心算法特性

### 风险评估算法
系统实现了完整的5种风险计算情况：

1. **情况1**：存在特大风险 → 直接定为特大风险
2. **情况2**：全部一般风险 → 使用综合评价公式计算
3. **情况3**：单一最大值 → 采用该风险等级
4. **情况4a**：多个较大风险最大值 → 重新归一化权重计算
5. **情况4b**：多个重大风险最大值 → 重新归一化权重计算

### 综合风险计算公式
```
α = k(1+l/50)∑(wi×ri)
```
其中：
- k：敏感度系数 [1.0-2.0]
- l：指标数量
- wi：指标权重
- ri：单指标风险值
- (1+l/50)：数量修正因子

### 敏感度系数
根据敏感时期、敏感地域、敏感属性三个维度计算敏感度系数：

| 敏感时期 | 敏感地域 | 敏感属性 | 系数k |
|---------|---------|---------|-------|
| 是      | 是      | 重大     | 2.0   |
| 是      | 是      | 较大     | 1.75  |
| 是      | 否      | 重大     | 1.75  |
| 否      | 是      | 重大     | 1.75  |
| 是      | 是      | 一般     | 1.5   |
| 是      | 否      | 较大     | 1.5   |
| 否      | 是      | 较大     | 1.5   |
| 否      | 否      | 重大     | 1.5   |
| 是      | 否      | 一般     | 1.25  |
| 否      | 是      | 一般     | 1.25  |
| 否      | 否      | 较大     | 1.25  |
| 否      | 否      | 一般     | 1.0   |

### 多选指标支持
以下指标支持多选输入，系统自动选择最高风险选项：
- **弹药类型 (dylx)**：可同时选择多种弹药类型
- **道路类型 (dllx)**：可同时选择多种道路类型
- **车辆安全配套设备 (claqptsb)**：可同时选择多种安全设备

## 📊 指标体系

### 人员因素 (9个指标)
- **岗位相关** (3个)：岗位种类齐全性、任职年限、一人多岗情况
- **政治素质** (2个)：共产党员占比、政治审查通过情况
- **业务素质** (4个)：安全教育、保密培训、实操技能、理论知识

### 物品因素 (9个指标)
- **弹药相关** (4个)：弹药类型、质量等级、重量、数量
- **机工具** (2个)：设备齐全性、设备状况
- **运输车辆** (3个)：车辆状况、安全配套设备、车辆数量

### 环境因素 (9个指标)
- **道路相关** (4个)：道路类型、运输距离、备用路线、保护区域
- **天气相关** (2个)：季节、特殊天气
- **社会因素** (3个)：社情民情、敌情、保密工作

### 管理因素 (15个指标)
- **管理组织** (3个)：领导组织机构、安全组织架构、组织职责
- **管理制度** (5个)：教育训练、安全制度、安全预案、安全设施、技术检查
- **管理机制** (4个)：安全分析、专家评审、风险预警、协调联动
- **管理能力** (3个)：计划统筹、贯彻落实、应急处置

### 任务因素 (3个指标)
- **任务性质** (2个)：特殊任务、紧急任务
- **任务强度** (1个)：任务时长

## 🚀 快速开始

### 1. 环境要求
```bash
Python 3.8+
FastAPI
ReportLab
Uvicorn
```

### 2. 安装依赖
```bash
pip install -r requirements.txt
```

### 3. 启动服务
```bash
# 方式1：使用启动脚本
python run.py

# 方式2：直接使用uvicorn
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### 4. 访问API
- 服务地址：`http://localhost:8000`
- API文档：`http://localhost:8000/docs`
- 健康检查：`http://localhost:8000/api/health`

## 📡 API接口

### 1. 获取指标信息
```http
GET /api/indicators
```

**响应示例：**
```json
{
    "code": 200,
    "message": "ok",
    "data": {
        "indicator_001": {
            "index_number": 1,
            "level_1": "人员因素",
            "level_2": "岗位",
            "level_3": "岗位种类是否齐全",
            "description": "管理干部、库房管理员、作业人员、警戒员、安全员、驾驶员是否齐全",
            "suggestion": "1.确定缺失哪类岗位\n2.补充缺失的岗位人员"
        }
        // ... 其他44个指标
    }
}
```

### 2. 风险评估
```http
POST /api/risk/evaluate
```

**请求体格式1（拼音编码 + 多选支持）：**
```json
{
    "jcxx": {
        "rwmc": "复合弹药运输任务",
        "pgdwmc": "特种运输单位"
    },
    "zbxx": {
        "dylx": ["1", "2", "3"],        // 多选：火炮弹药、航空弹药、特种弹药
        "dllx": ["2", "3"],             // 多选：二级公路、三级公路
        "claqptsb": ["0", "2"],         // 多选：灭火器、防静电装备
        "gcdyzb": "3",                  // 单选：共产党员占比
        "gwzlsfqq": "1"                 // 单选：岗位种类齐全
    },
    "mgdxx": {
        "sensitive_time": "1",          // 字符串格式：敏感时期
        "sensitive_area": "1",          // 字符串格式：敏感地域
        "sensitive_attribute": "2"      // 字符串格式：敏感属性
    }
}
```

**请求体格式2（indicator编码）：**
```json
{
    "jcxx": {
        "rwmc": "日常运输任务",
        "pgdwmc": "运输单位"
    },
    "zbxx": {
        "indicator_004": "2",           // 共产党员占比
        "indicator_010": "1",           // 弹药类型
        "indicator_019": "2"            // 道路类型
    },
    "mgdxx": {
        "sensitive_time": "0",
        "sensitive_area": "0",
        "sensitive_attribute": "1"
    }
}
```

**响应示例：**
```json
{
    "code": 200,
    "message": "ok",
    "data": {
        "level": "重大",
        "detail": {
            "弹药类型": [
                "8",                    // 可能性等级
                "9",                    // 危害程度等级
                "72",                   // 风险值
                "特大",                  // 风险等级
                "1.避免高风险弹药混装",   // 对策建议
                "物品因素-弹药-弹药类型", // 指标分类
                "包含的弹药类型",        // 指标描述
                10,                     // 指标序号
                3                       // 选择的值（多选时为最高风险的值）
            ]
            // ... 其他指标详情
        },
        "report_time": "2025-07-04",
        "rwmc": "复合弹药运输任务",
        "dwmc": "特种运输单位",
        "filePath": "reports/risk_report_xxxxx.pdf",
        "sensitivity_coefficient": 2.0,     // 敏感度系数
        "adjusted_risk_value": 72,          // 调整后的风险值
        "indicator_count": 5,               // 指标数量
        "calculation_info": {
            "method": "完整风险评估逻辑",
            "formula": "根据风险等级分布确定计算方法",
            "risk_values": [72, 42, 56, 28, 4],
            "max_risk_value": 72,
            "calculation_case": "情况1: 存在特大风险，直接定为特大风险"
        }
    }
}
```

## 🎨 风险等级说明

| 风险值范围 | 风险等级 | 可容许性 | 颜色标识 |
|-----------|---------|---------|---------|
| R<21      | 一般    | 可接受   | 绿色    |
| 21≤R<42   | 较大    | 中间     | 黄色    |
| 42≤R<70   | 重大    | 中间     | 橙色    |
| 70≤R≤100  | 特大    | 不可接受 | 红色    |

**单指标风险值计算公式：** R = L × C （可能性等级 × 危害程度等级）

## 📁 项目结构

```
fastApiProject/
├── app/                           # 主应用包
│   ├── __init__.py
│   ├── main.py                    # FastAPI应用入口
│   ├── api/                       # API模块
│   │   ├── __init__.py
│   │   └── routes.py              # API路由定义
│   ├── core/                      # 核心配置模块
│   │   ├── __init__.py
│   │   └── config.py              # 应用配置
│   ├── models/                    # 数据模型模块
│   │   ├── __init__.py
│   │   └── schemas.py             # Pydantic数据模型
│   ├── services/                  # 业务逻辑服务模块
│   │   ├── __init__.py
│   │   ├── risk_evaluator.py      # 风险评估服务
│   │   └── pdf_generator.py       # PDF生成服务
│   └── utils/                     # 工具函数模块
│       ├── __init__.py
│       └── indicators.py          # 指标配置与算法
├── tests/                         # 测试文件目录
│   ├── test_api.py                # API测试
│   ├── test_data.json             # 测试数据
│   ├── test_multi_select.py       # 多选指标测试
│   ├── test_simple_multi.py       # 简单多选测试
│   └── 测试使用说明.md             # 测试说明文档
├── reports/                       # 生成的PDF报告
├── run.py                         # 项目启动文件
├── requirements.txt               # 项目依赖
├── Dockerfile                     # Docker配置
├── docker-compose.yml             # Docker Compose配置
├── 指标数据模板.md                 # 指标配置说明
├── 中文字体说明.md                 # 字体配置说明
├── 部署说明.md                    # 部署指南
└── README.md                      # 项目说明
```

## 🧪 测试

### 运行完整测试套件
```bash
cd fastApiProject
python tests/test_api.py
```

### 测试多选指标功能
```bash
python tests/test_multi_select.py
```

### 测试简单多选功能
```bash
python tests/test_simple_multi.py
```

### 测试数据说明
测试文件包含8个测试案例：
- **case_1-6**：基础功能测试
- **case_7**：多选指标高风险测试
- **case_8**：多选指标混合风险测试

## 🔧 高级功能

### 多选指标处理
对于支持多选的指标，系统会自动选择风险值最高的选项：

```python
# 弹药类型多选示例
"dylx": ["0", "2", "3"]  # 轻武器、航空、特种弹药
# 系统自动选择：特种弹药(3)，风险值=72
```

### 敏感度调节
系统根据任务的敏感性动态调整风险系数：

```python
# 高敏感度任务
"mgdxx": {
    "sensitive_time": "1",      # 敏感时期
    "sensitive_area": "1",      # 敏感地域
    "sensitive_attribute": "2"   # 重大敏感属性
}
# 敏感度系数：k = 2.0
```

### 风险等级自动判定
系统根据5种计算情况自动选择最合适的评估方法：
1. 优先检查特大风险
2. 全部一般风险时使用综合公式
3. 单一最大值直接采用
4. 多个最大值重新计算权重

## 🐳 Docker部署

### 1. 构建镜像
```bash
docker build -t ahp-risk-system .
```

### 2. 运行容器
```bash
docker run -p 8000:8000 ahp-risk-system
```

### 3. 使用Docker Compose
```bash
docker-compose up -d
```

## 📊 指标配置说明

所有45个指标都已完整配置，每个指标包含：

- **基本信息**：序号、分类层级、名称、描述
- **风险矩阵**：不同输入值对应的可能性和严重程度等级
- **对策建议**：针对性的风险应对措施
- **拼音编码**：支持中文拼音输入方式

详细的指标配置参见 `指标数据模板.md` 文件。

## 🔧 自定义配置

### 修改指标配置
编辑 `app/utils/indicators.py` 文件中的 `INDICATORS_CONFIG` 字典。

### 添加多选指标
在 `MULTI_SELECT_INDICATORS` 集合中添加新的拼音编码。

### 调整风险等级
修改 `app/utils/indicators.py` 文件中的 `RISK_LEVELS` 配置。

### 自定义PDF模板
修改 `app/services/pdf_generator.py` 文件中的PDF生成逻辑。

### 调整敏感度系数
修改 `get_sensitivity_coefficient` 函数中的系数计算逻辑。

---

**注意：** 此系统已完整实现45个风险指标的评估功能，支持多选指标、敏感度调节、完整算法等高级特性，所有模块均已测试通过，可直接投入生产使用。
